package cn.polarismesh.agent.plugin.nacos.delegate;


import cn.polarismesh.agent.plugin.nacos.constants.NacosConstants;

import com.alibaba.nacos.api.exception.NacosException;
import com.alibaba.nacos.client.naming.net.NamingProxy;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Map;
import java.util.Properties;


public class DynamicNamingProxy extends NamingProxy {


    private String secondaryServer;
    private NamingProxyAssist assist;
    private Logger logger = LoggerFactory.getLogger("com.alibaba.nacos.client.naming");


    public DynamicNamingProxy(String namespaceId, String endpoint, String serverList, Properties properties) {
        super(namespaceId, endpoint, serverList, properties);
        init();
    }

    private void init() {
        this.secondaryServer = System.getProperty(NacosConstants.OTHER_NACOS_SERVER_ADDR);
        this.assist = new NamingProxyAssist();
    }

    @Override
    public String callServer(String api, Map<String, String> params, String body, String curServer, String method) throws NacosException {
        String fullApi = api + NacosConstants.LINK_FLAG + method;

        // 在注册服务时候插入元数据
        if (NacosConstants.REGISTER_SERVICE.equals(fullApi)) {
            try {
                assist.fillMetadata(params);
            } catch (Exception e) {
                logger.error("register service fillMetadata failed: ", e);
            }
        }

        // 查询列表时候从组合两个数据源
        if (NacosConstants.QUERY_LIST.equals(fullApi)) {
            return queryListCallServerProxy(api, params, body, curServer, method);
        }

        String primaryRet = null;
        NacosException primaryEx = null;
        try {
            primaryRet = super.callServer(api, params, body, curServer, method);
        } catch (NacosException e) {
            primaryEx = e;
            logger.error("primaryServer callServer failed: {} ", curServer, e);
        }

        String secondaryRet = null;
        NacosException secondaryEx = null;
        try {
            secondaryRet = super.callServer(api, params, body, this.secondaryServer, method);
        } catch (NacosException e) {
            secondaryEx = e;
            logger.error("secondaryServer callServer failed: {} ", this.secondaryServer, e);
        }

        // 两次调用都失败
        if (primaryEx != null && secondaryEx != null) {
            throw primaryEx;
        }

        // 优先返回 primary 的结果
        if (primaryEx == null) {
            return primaryRet;
        } else {
            return secondaryRet;
        }
    }

    private String queryListCallServerProxy(String api, Map<String, String> params,  String body, String curServer, String method) throws NacosException {
        String primaryList = "";
        NacosException primaryEx = null;
        try {
            primaryList = super.callServer(api, params, body, curServer, method);
        } catch (NacosException e) {
            primaryEx = e;
            logger.error("queryListCallServerProxy  {} failed.", curServer, e);
        }
        String secondaryList = "";
        NacosException secondaryEx = null;
        try {
            secondaryList = super.callServer(api, params, body, secondaryServer, method);
        } catch (NacosException e) {
            secondaryEx = e;
            logger.error("queryListCallServerProxy  {} failed.", this.secondaryServer, e);
        }
        // 两次调用都失败
        if (primaryEx != null && secondaryEx != null) {
            throw primaryEx;
        }

        try {
            return assist.mergeResult(primaryList, secondaryList);
        } catch (Exception e) {
            logger.error("mergeResult failed: ", e);
            // 优先返回 primary 的结果
            if (primaryEx == null) {
                return primaryList;
            } else {
                return secondaryList;
            }
        }

    }

}
